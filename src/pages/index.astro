---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import VisualsCard from "@/components/VisualsCard.astro";
import { basics } from "@cv";
import "@/styles/colors.css";
import Mail from "@/icons/Mail.astro";
import GitHub from "@/icons/GitHub.astro";
import LinkedIn from "@/icons/LinkedIn.astro";
import Bsky from "@/icons/Bsky.astro";
import Sun from "@/icons/Sun.astro";
import type { SocialIcon } from "@/types";

const { name, label, image, summary, profiles, email } = basics;

const SOCIAL_ICONS: SocialIcon = {
	GitHub,
	LinkedIn,
	Bsky,
};

const allProjects = await getCollection("projects");
const featuredProjects = allProjects
	.filter((p) => p.data.featured)
	.sort((a, b) => a.data.order - b.data.order);

const allVisuals = await getCollection("visuals");
const featuredVisuals = allVisuals
	.filter((v) => v.data.featured && !v.slug.startsWith("_"))
	.sort((a, b) => a.data.order - b.data.order);
---

<Layout title={`Cello - ${label}`}>
	<section class="hero">
		<div class="hero-content">
			<div class="title-block">
				<h1 class="nickname" id="typewriter-name"><span class="typewriter-text"></span><span class="cursor">|</span></h1>
				<div class="bar"></div>
			</div>
			<p class="label">{label}</p>
			<p class="summary">{summary}</p>
			<nav class="actions">
				<a href="/resume" class="btn">View Resume</a>
				<a href="/projects" class="btn outline">Projects</a>
			</nav>
		</div>
		<div class="hero-visual">
			<div class="image-frame">
				<img src={image} alt={name} />
			</div>
			<div class="socials">
				{email && (
					<a href={`mailto:${email}`} title="Email" target="_blank" rel="noopener noreferrer">
						<Mail />
					</a>
				)}
				{profiles.map(({ network, url }) => {
					const Icon = SOCIAL_ICONS[network];
					return (
						<a href={url} title={network} target="_blank" rel="noopener noreferrer">
							<Icon />
						</a>
					);
				})}
				<button onclick="toggleTheme()" aria-label="Toggle theme">
					<Sun />
				</button>
			</div>
		</div>
	</section>

	<div class="projects-section-wrapper">
	<Section title="Projects">
		<div class="bar section-bar"></div>
		<div class="projects-grid">
			{featuredProjects.map((project, i) => (
				<ProjectCard
					title={project.data.title}
					description={project.data.description}
					image={project.data.image}
					url={project.data.url}
					techStack={project.data.techStack}
					role={project.data.role}
					slug={project.slug}
					index={i}
				/>
			))}
		</div>
		<a href="/projects" class="view-all">
			<span>All Projects</span>
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
				<path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
		</a>
	</Section>
	</div>

	{featuredVisuals.length > 0 && (
		<div class="visuals-section-wrapper">
			<Section title="Visuals">
				<div class="bar section-bar"></div>
				<div class="visuals-grid">
					{featuredVisuals.map((item, i) => (
						<VisualsCard
							title={item.data.title}
							description={item.data.description}
							category={item.data.category}
							image={item.data.image}
							tags={item.data.tags}
							slug={item.slug}
							index={i}
						/>
					))}
				</div>
				<a href="/visuals" class="view-all visuals-view-all">
					<span>All Visuals</span>
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
						<path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</a>
			</Section>
		</div>
	)}
</Layout>

<script is:inline>
	function setTheme(theme) {
		document.documentElement.setAttribute("data-theme", theme);
		localStorage.setItem("theme", theme);
	}

	function toggleTheme() {
		const currentTheme = localStorage.getItem("theme") || "dark";
		const newTheme = currentTheme === "dark" ? "light" : "dark";
		setTheme(newTheme);
	}

	// Typewriter animation
	function initTypewriter() {
		const text = "Cello";
		const element = document.querySelector(".typewriter-text");
		if (!element) return;

		const typeSpeed = 150;
		const eraseSpeed = 100;
		const pauseAfterType = 2000;
		const pauseAfterErase = 500;

		let charIndex = 0;
		let isTyping = true;

		function type() {
			if (charIndex < text.length) {
				element.textContent = text.substring(0, charIndex + 1);
				charIndex++;
				setTimeout(type, typeSpeed);
			} else {
				isTyping = false;
				setTimeout(erase, pauseAfterType);
			}
		}

		function erase() {
			if (charIndex > 0) {
				element.textContent = text.substring(0, charIndex - 1);
				charIndex--;
				setTimeout(erase, eraseSpeed);
			} else {
				isTyping = true;
				setTimeout(type, pauseAfterErase);
			}
		}

		type();
	}

	document.addEventListener("DOMContentLoaded", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
		initTypewriter();
	});

	document.addEventListener("astro:after-swap", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
		initTypewriter();
	});
</script>

<style>
	.hero {
		display: grid;
		grid-template-columns: 1fr auto;
		gap: 4rem;
		align-items: center;
		min-height: 40vh;
		padding: 2rem;
		max-width: 1100px;
		margin: 0 auto;
	}

	.hero-content {
		animation: slideLeft 0.8s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.title-block {
		margin-bottom: 1.5rem;
	}

	h1.nickname {
		font-size: 10rem !important;
		line-height: 1 !important;
		margin: 0;
		padding: 0;
		color: var(--color-accent);
		display: inline-flex;
		align-items: baseline;
		letter-spacing: normal;
		white-space: nowrap;
	}

	@media (max-width: 900px) {
		h1.nickname {
			font-size: 6rem !important;
		}
	}

	@media (max-width: 600px) {
		h1.nickname {
			font-size: 4rem !important;
		}
	}

	.typewriter-text {
		display: inline-block;
		min-width: 1ch;
		font-size: inherit !important;
	}

	.cursor {
		display: inline-block;
		color: var(--color-text);
		font-weight: 400;
		font-size: inherit !important;
		animation: blink 0.7s step-end infinite;
	}

	@keyframes blink {
		0%, 100% { opacity: 1; }
		50% { opacity: 0; }
	}

	.bar {
		width: 100px;
		height: 6px;
		background: var(--color-accent);
		margin-top: 1rem;
		margin-left: 0.8rem;
		animation: wipeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
	}

	.section-bar {
		margin-bottom: 1.5rem;
	}

	.label {
		font-size: 1rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--color-text);
		margin-bottom: 1rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
	}

	.summary {
		font-size: 1rem;
		line-height: 1.7;
		max-width: 45ch;
		margin-bottom: 2rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
	}

	.actions {
		display: flex;
		gap: 1rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
	}

	.btn {
		display: inline-block;
		padding: 0.8rem 1.5rem;
		font-size: 0.85rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		background: var(--color-accent);
		color: var(--color-background);
		border: 3px solid var(--color-accent);
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.btn:hover {
		background: var(--color-background);
		color: var(--color-accent);
	}

	.btn.outline {
		background: transparent;
		color: var(--color-text);
		border-color: var(--color-text);
	}

	.btn.outline:hover {
		background: var(--color-text);
		color: var(--color-background);
	}

	.hero-visual {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1.5rem;
		animation: slideRight 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
	}

	.image-frame {
		position: relative;
		border: 4px solid var(--color-text);
	}

	.image-frame::before {
		content: "";
		position: absolute;
		top: 10px;
		left: 10px;
		right: -10px;
		bottom: -10px;
		border: 4px solid var(--color-accent);
		z-index: -1;
	}

	img {
		width: 300px;
		height: 300px;
		object-fit: cover;
		display: block;
		filter: grayscale(30%);
		transition: filter 0.3s ease;
	}

	.image-frame:hover img {
		filter: grayscale(0%);
	}

	.socials {
		display: flex;
		gap: 0.5rem;
	}

	.socials a,
	.socials button {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 40px;
		height: 40px;
		border: 2px solid var(--color-text);
		background: var(--color-background);
		color: var(--color-text);
		cursor: pointer;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.socials a:hover,
	.socials button:hover {
		background: var(--color-accent);
		border-color: var(--color-accent);
		color: var(--color-background);
	}

	.projects-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 2rem;
	}

	.projects-section-wrapper {
		margin-top: 8rem;
	}

	.visuals-section-wrapper {
		margin-top: 8rem;
	}

	.visuals-section-wrapper :global(.card) {
		--color-accent: var(--color-sunset);
	}

	.visuals-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 2rem;
	}

	.view-all {
		display: inline-flex;
		align-items: center;
		gap: 0.75rem;
		margin-top: 2rem;
		color: var(--color-accent);
		font-weight: 700;
		font-size: 1rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		transition: gap 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.view-all:hover {
		gap: 1rem;
	}

	@keyframes slideLeft {
		from {
			opacity: 0;
			transform: translateX(-60px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	@keyframes slideRight {
		from {
			opacity: 0;
			transform: translateX(60px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@keyframes wipeIn {
		from {
			transform: scaleX(0);
			transform-origin: left;
		}
		to {
			transform: scaleX(1);
			transform-origin: left;
		}
	}

	@media (width <= 900px) {
		.visuals-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (width <= 700px) {
		.hero {
			grid-template-columns: 1fr;
			gap: 2rem;
			min-height: auto;
			padding: 2rem 1rem;
		}

		.hero-visual {
			order: -1;
		}

		.hero-content {
			text-align: center;
		}

		.title-block {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.bar {
			margin-left: 0;
		}

		.summary {
			max-width: none;
		}

		.actions {
			justify-content: center;
			flex-wrap: wrap;
		}

		.image-frame::before {
			top: 8px;
			left: 8px;
			right: -8px;
			bottom: -8px;
		}

		img {
			width: 240px;
			height: 240px;
		}

		.projects-grid {
			grid-template-columns: 1fr;
		}

		.visuals-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
