---
import { getCollection, render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import "@/styles/colors.css";

export async function getStaticPaths() {
	const projects = await getCollection("projects");
	return projects.map((project) => ({
		params: { slug: project.slug },
		props: { project },
	}));
}

const { project } = Astro.props;
const { Content } = await render(project);
const { title, description, image, url, github, techStack, role, highlights, media } = project.data;

const isVideo = (src: string) => src?.endsWith('.webm') || src?.endsWith('.mp4');
const mainIsVideo = isVideo(image || '');
---

<Layout title={`${title} - Marcelo Rondon`}>
	<article class="project-page">
		<Section>
			<div class="top-row">
				<span class="role-badge">{role}</span>
				<a href="/projects" class="back-link">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
						<path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					<span>Back</span>
				</a>
			</div>

			<header class="project-header">
				<h1>{title}</h1>
				<div class="bar"></div>
				<p class="description">{description}</p>

				<ul class="tech-stack">
					{techStack.map((tech, i) => (
						<li style={`--i: ${i}`}>{tech}</li>
					))}
				</ul>

				<div class="links">
					{url && (
						<a href={url} target="_blank" rel="noopener noreferrer" class="btn">
							<span>View Live</span>
							<svg width="18" height="18" viewBox="0 0 18 18" fill="none">
								<path d="M13.5 9.75V14.25C13.5 15.4926 12.4926 16.5 11.25 16.5H3.75C2.50736 16.5 1.5 15.4926 1.5 14.25V6.75C1.5 5.50736 2.50736 4.5 3.75 4.5H8.25M11.25 1.5H16.5M16.5 1.5V6.75M16.5 1.5L7.5 10.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
							</svg>
						</a>
					)}
					{github && (
						<a href={github} target="_blank" rel="noopener noreferrer" class="btn outline">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
								<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
							</svg>
							<span>GitHub</span>
						</a>
					)}
				</div>
			</header>
		</Section>

{image && (
	<Section>
		<div class="media-gallery media-full">
			{mainIsVideo ? (
				<video src={image} class="project-media" autoplay loop muted playsinline />
			) : (
				<img src={image} alt={title} class="project-media" />
			)}
		</div>
	</Section>
)}

{media && media.map((gallery) => (
	<Section>
		<div class={`media-gallery media-${gallery.layout}`}>
			{gallery.items.map((item, itemIndex) => (
				<figure class="media-item" style={`--i: ${itemIndex}`}>
					{isVideo(item.src) ? (
						<video src={item.src} class="project-media" autoplay loop muted playsinline />
					) : (
						<img src={item.src} alt={item.alt || title} class="project-media" />
					)}
					{item.caption && <figcaption>{item.caption}</figcaption>}
				</figure>
			))}
		</div>
	</Section>
))}

		{highlights.length > 0 && (
			<Section>
				<h2>Highlights</h2>
				<div class="bar"></div>
				<ul class="highlights">
					{highlights.map((highlight, i) => (
						<li style={`--i: ${i}`}>{highlight}</li>
					))}
				</ul>
			</Section>
		)}

		<Section>
			<div class="content">
				<Content />
			</div>
		</Section>

		<Section>
			<div class="footer-nav">
				<a href="/projects" class="nav-link">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
						<path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					<span>All Projects</span>
				</a>
			</div>
		</Section>
	</article>
</Layout>

<script is:inline>
	function setTheme(theme) {
		document.documentElement.setAttribute("data-theme", theme);
		localStorage.setItem("theme", theme);
	}

	document.addEventListener("DOMContentLoaded", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
	});

	document.addEventListener("astro:after-swap", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
	});
</script>

<style>
	.project-page {
		padding-top: 1rem;
	}

	.top-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-inline: 0.8rem;
		margin-bottom: 1.5rem;
	}

	.back-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		color: var(--color-text);
		font-size: 0.9rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.back-link:hover {
		color: var(--color-accent);
		gap: 0.75rem;
	}

	.project-header {
		padding-inline: 0.8rem;
	}

	.role-badge {
		display: inline-block;
		font-size: 0.8rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--color-accent);
		border: 2px solid var(--color-accent);
		padding: 0.4rem 0.8rem;
	}

	h1 {
		font-size: clamp(2.5rem, 8vw, 4rem);
		line-height: 1.1;
		margin: 0 0 1rem 0;
		padding: 0;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
	}

	.bar {
		width: 80px;
		height: 5px;
		background: var(--color-accent);
		margin-bottom: 1.5rem;
		animation: wipeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
	}

	.description {
		font-size: 1.1rem;
		line-height: 1.8;
		max-width: 60ch;
		margin: 0 0 2rem 0;
		padding: 0;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
	}

	.tech-stack {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-bottom: 2rem;
	}

	.tech-stack li {
		font-size: 0.75rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--color-text);
		border: 2px solid var(--color-text);
		padding: 0.4rem 0.8rem;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
		animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
		animation-delay: calc(0.4s + var(--i) * 0.05s);
	}

	.tech-stack li:hover {
		background: var(--color-text);
		color: var(--color-background);
	}

	.links {
		display: flex;
		gap: 1rem;
		flex-wrap: wrap;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.5s backwards;
	}

	.btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.8rem 1.5rem;
		font-size: 0.85rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		background: var(--color-accent);
		color: var(--color-background);
		border: 3px solid var(--color-accent);
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.btn:hover {
		background: var(--color-background);
		color: var(--color-accent);
	}

	.btn.outline {
		background: transparent;
		color: var(--color-text);
		border-color: var(--color-text);
	}

	.btn.outline:hover {
		background: var(--color-text);
		color: var(--color-background);
	}

	/* Media Gallery Layouts */
	.media-gallery {
		padding-inline: 0.8rem;
		animation: scaleIn 0.7s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.media-full {
		display: block;
	}

	.media-two {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1rem;
	}

	.media-three {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 1rem;
	}

	.media-item {
		margin: 0;
		animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
		animation-delay: calc(var(--i) * 0.1s);
	}

	.media-item figcaption {
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--color-text);
		padding: 0.75rem 0;
		border-bottom: 2px solid var(--color-accent);
		margin: 0;
	}

	.project-media {
		width: 100%;
		border: 4px solid var(--color-text);
		filter: grayscale(20%);
		transition: filter 0.3s ease;
	}

	.media-full .project-media {
		max-height: 600px;
		object-fit: cover;
	}

	.media-two .project-media,
	.media-three .project-media {
		aspect-ratio: 16/10;
		object-fit: cover;
	}

	video.project-media {
		height: auto;
		aspect-ratio: auto;
	}

	.project-media:hover {
		filter: grayscale(0%);
	}

	@media (width <= 900px) {
		.media-three {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (width <= 700px) {
		.media-two,
		.media-three {
			grid-template-columns: 1fr;
		}

		.media-full .project-media {
			max-height: 300px;
		}
	}

	h2 {
		font-size: clamp(1.5rem, 4vw, 2rem);
		line-height: 1.2;
		margin: 0 0 0.75rem 0;
		animation: slideLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.highlights {
		padding-inline: 0.8rem;
	}

	.highlights li {
		position: relative;
		padding-left: 2rem;
		margin-bottom: 1rem;
		font-size: 1rem;
		line-height: 1.7;
		animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
		animation-delay: calc(var(--i) * 0.1s);
	}

	.highlights li::before {
		content: "→";
		position: absolute;
		left: 0;
		color: var(--color-accent);
		font-weight: 700;
	}

	.content {
		padding-inline: 0.8rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.content :global(h2) {
		font-size: 1.5rem;
		line-height: 1.2;
		color: var(--color-accent);
		margin: 3rem 0 1rem 0;
		padding: 0;
		text-transform: uppercase;
	}

	.content :global(h2:first-child) {
		margin-top: 0;
	}

	.content :global(p) {
		padding: 0;
		margin: 0 0 1.25rem 0;
		font-size: 1rem;
		line-height: 1.8;
	}

	.content :global(ul),
	.content :global(ol) {
		padding-left: 1.5rem;
		margin: 0 0 1.25rem 0;
	}

	.content :global(ul) {
		list-style: none;
	}

	.content :global(ul li) {
		position: relative;
		padding-left: 1.5rem;
	}

	.content :global(ul li::before) {
		content: "—";
		position: absolute;
		left: 0;
		color: var(--color-accent);
		font-weight: 700;
	}

	.content :global(ol) {
		list-style: decimal;
	}

	.content :global(li) {
		margin-bottom: 0.5rem;
		line-height: 1.7;
	}

	.content :global(code) {
		background: rgba(var(--color-accent-rgb), 0.1);
		border: 1px solid rgba(var(--color-accent-rgb), 0.2);
		padding: 0.2rem 0.4rem;
		font-size: 0.9em;
	}

	.content :global(pre) {
		background: var(--color-text);
		color: var(--color-background);
		border: 3px solid var(--color-text);
		padding: 1.5rem;
		overflow-x: auto;
		margin: 0 0 1.5rem 0;
	}

	.content :global(pre code) {
		background: none;
		border: none;
		padding: 0;
	}

	.content :global(blockquote) {
		border-left: 4px solid var(--color-accent);
		padding-left: 1.5rem;
		margin: 1.5rem 0;
		font-style: italic;
	}

	.footer-nav {
		display: flex;
		justify-content: center;
		padding: 3rem 0.8rem;
		border-top: 3px solid var(--color-text);
		margin-top: 2rem;
	}

	.nav-link {
		display: inline-flex;
		align-items: center;
		gap: 0.75rem;
		color: var(--color-accent);
		font-weight: 700;
		font-size: 1rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		padding: 0.8rem 1.5rem;
		border: 3px solid var(--color-accent);
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.nav-link:hover {
		background: var(--color-accent);
		color: var(--color-background);
		gap: 0.5rem;
	}

	@keyframes slideLeft {
		from {
			opacity: 0;
			transform: translateX(-40px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@keyframes wipeIn {
		from {
			transform: scaleX(0);
			transform-origin: left;
		}
		to {
			transform: scaleX(1);
			transform-origin: left;
		}
	}

	@keyframes scaleIn {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	@media (width <= 700px) {
		.project-page {
			padding-top: 0.5rem;
		}

		h1 {
			font-size: clamp(2rem, 10vw, 3rem);
		}

		.description {
			font-size: 1rem;
		}

		.project-image {
			max-height: 300px;
		}

		.btn {
			padding: 0.6rem 1rem;
			font-size: 0.8rem;
		}

		.links {
			flex-direction: column;
		}

		.btn {
			justify-content: center;
		}
	}
</style>
