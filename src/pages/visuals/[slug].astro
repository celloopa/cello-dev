---
import { getCollection, render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import "@/styles/colors.css";

export async function getStaticPaths() {
	const visuals = await getCollection("visuals");
	return visuals
		.filter((v) => !v.slug.startsWith("_"))
		.map((item) => ({
			params: { slug: item.slug },
			props: { item },
		}));
}

const { item } = Astro.props;
const { Content } = await render(item);
const { title, description, category, image, tags, media } = item.data;

const isVideo = (src: string) => src?.endsWith('.webm') || src?.endsWith('.mp4');
const mainIsVideo = isVideo(image || '');
---

<Layout title={`${title} - Marcelo Rondon`}>
	<article class="visuals-page">
		<Section>
			<a href="/visuals" class="back-link">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
					<path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
				<span>Back</span>
			</a>

			<header class="visuals-header">
				<span class="category-badge">{category}</span>
				<h1>{title}</h1>
				<div class="bar"></div>
				<p class="description">{description}</p>

				{tags && tags.length > 0 && (
					<ul class="tags">
						{tags.map((tag, i) => (
							<li style={`--i: ${i}`}>{tag}</li>
						))}
					</ul>
				)}
			</header>
		</Section>

		{image && (
			<Section>
				<div class="media-gallery media-full">
					{mainIsVideo ? (
						<video src={image} class="visuals-media" autoplay loop muted playsinline />
					) : (
						<img src={image} alt={title} class="visuals-media" />
					)}
				</div>
			</Section>
		)}

		{media && media.map((gallery) => (
			<Section>
				<div class={`media-gallery media-${gallery.layout}`}>
					{gallery.items.map((item, itemIndex) => (
						<figure class="media-item" style={`--i: ${itemIndex}`}>
							{isVideo(item.src) ? (
								<video src={item.src} class="visuals-media" autoplay loop muted playsinline />
							) : (
								<img src={item.src} alt={item.alt || title} class="visuals-media" />
							)}
							{item.caption && <figcaption>{item.caption}</figcaption>}
						</figure>
					))}
				</div>
			</Section>
		))}

		<Section>
			<div class="content">
				<Content />
			</div>
		</Section>

		<Section>
			<div class="footer-nav">
				<a href="/visuals" class="nav-link">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
						<path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					<span>All Visuals</span>
				</a>
			</div>
		</Section>
	</article>
</Layout>

<script is:inline>
	function setTheme(theme) {
		document.documentElement.setAttribute("data-theme", theme);
		localStorage.setItem("theme", theme);
	}

	document.addEventListener("DOMContentLoaded", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
	});

	document.addEventListener("astro:after-swap", () => {
		const savedTheme = localStorage.getItem("theme") || "dark";
		setTheme(savedTheme);
	});
</script>

<style>
	.visuals-page {
		--color-accent: var(--color-treescape);
		padding-top: 2rem;
	}

	.back-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		color: var(--color-text);
		font-size: 0.9rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		padding-inline: 0.8rem;
		margin-bottom: 2rem;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
		animation: slideLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.back-link:hover {
		color: var(--color-accent);
		gap: 0.3rem;
	}

	.visuals-header {
		padding-inline: 0.8rem;
	}

	.category-badge {
		display: inline-block;
		font-size: 0.8rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--color-accent);
		border: 2px solid var(--color-accent);
		padding: 0.4rem 0.8rem;
		margin-bottom: 1.5rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	h1 {
		font-size: clamp(2.5rem, 8vw, 4rem);
		line-height: 1.1;
		margin: 0 0 1rem 0;
		padding: 0;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
	}

	.bar {
		width: 80px;
		height: 5px;
		background: var(--color-accent);
		margin-bottom: 1.5rem;
		animation: wipeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
	}

	.description {
		font-size: 1.1rem;
		line-height: 1.8;
		max-width: 60ch;
		margin: 0 0 2rem 0;
		padding: 0;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-bottom: 2rem;
	}

	.tags li {
		font-size: 0.75rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--color-text);
		border: 2px solid var(--color-text);
		padding: 0.4rem 0.8rem;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
		animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
		animation-delay: calc(0.4s + var(--i) * 0.05s);
	}

	.tags li:hover {
		background: var(--color-text);
		color: var(--color-background);
	}

	/* Media Gallery Layouts */
	.media-gallery {
		padding-inline: 0.8rem;
		animation: scaleIn 0.7s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.media-full {
		display: block;
	}

	.media-two {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1rem;
	}

	.media-three {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 1rem;
	}

	.media-item {
		margin: 0;
		animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
		animation-delay: calc(var(--i) * 0.1s);
	}

	.media-item figcaption {
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--color-text);
		padding: 0.75rem 0;
		border-bottom: 2px solid var(--color-accent);
		margin: 0;
	}

	.visuals-media {
		width: 100%;
		border: 4px solid var(--color-text);
		filter: grayscale(20%);
		transition: filter 0.3s ease;
	}

	.media-full .visuals-media {
		max-height: 600px;
		object-fit: cover;
	}

	.media-two .visuals-media,
	.media-three .visuals-media {
		aspect-ratio: 16/10;
		object-fit: cover;
	}

	video.visuals-media {
		height: auto;
		aspect-ratio: auto;
	}

	.visuals-media:hover {
		filter: grayscale(0%);
	}

	@media (width <= 900px) {
		.media-three {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (width <= 700px) {
		.media-two,
		.media-three {
			grid-template-columns: 1fr;
		}

		.media-full .visuals-media {
			max-height: 300px;
		}
	}

	.content {
		padding-inline: 0.8rem;
		animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
	}

	.content :global(h2) {
		font-size: 1.5rem;
		line-height: 1.2;
		color: var(--color-accent);
		margin: 3rem 0 1rem 0;
		padding: 0;
		text-transform: uppercase;
	}

	.content :global(h2:first-child) {
		margin-top: 0;
	}

	.content :global(p) {
		padding: 0;
		margin: 0 0 1.25rem 0;
		font-size: 1rem;
		line-height: 1.8;
	}

	.content :global(ul),
	.content :global(ol) {
		padding-left: 1.5rem;
		margin: 0 0 1.25rem 0;
	}

	.content :global(ul) {
		list-style: none;
	}

	.content :global(ul li) {
		position: relative;
		padding-left: 1.5rem;
	}

	.content :global(ul li::before) {
		content: "â€”";
		position: absolute;
		left: 0;
		color: var(--color-accent);
		font-weight: 700;
	}

	.content :global(ol) {
		list-style: decimal;
	}

	.content :global(li) {
		margin-bottom: 0.5rem;
		line-height: 1.7;
	}

	.footer-nav {
		display: flex;
		justify-content: center;
		padding: 3rem 0.8rem;
		border-top: 3px solid var(--color-text);
		margin-top: 2rem;
	}

	.nav-link {
		display: inline-flex;
		align-items: center;
		gap: 0.75rem;
		color: var(--color-accent);
		font-weight: 700;
		font-size: 1rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		padding: 0.8rem 1.5rem;
		border: 3px solid var(--color-accent);
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.nav-link:hover {
		background: var(--color-accent);
		color: var(--color-background);
		gap: 0.5rem;
	}

	@keyframes slideLeft {
		from {
			opacity: 0;
			transform: translateX(-40px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@keyframes wipeIn {
		from {
			transform: scaleX(0);
			transform-origin: left;
		}
		to {
			transform: scaleX(1);
			transform-origin: left;
		}
	}

	@keyframes scaleIn {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	@media (width <= 700px) {
		.visuals-page {
			padding-top: 1rem;
		}

		h1 {
			font-size: clamp(2rem, 10vw, 3rem);
		}

		.description {
			font-size: 1rem;
		}
	}
</style>
